/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var x=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var R=(c,r)=>{for(var t in r)x(c,t,{get:r[t],enumerable:!0})},U=(c,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of B(r))!K.call(c,i)&&i!==t&&x(c,i,{get:()=>r[i],enumerable:!(e=j(r,i))||e.enumerable});return c};var N=c=>U(x({},"__esModule",{value:!0}),c);var Q={};R(Q,{default:()=>M});module.exports=N(Q);var d=require("obsidian");var p=require("obsidian"),T=new WeakMap;function V(c){return c.containerEl.matches(".fs-block.fs-leaf-view .workspace-leaf")}function $(c){let r=[];for(let t=0;t<c;t++)r.push((16*Math.random()|0).toString(16));return r.join("")}function z(c){let r=function(){return Object.setPrototypeOf(new p.Component,new.target.prototype)};return r.prototype=c.prototype,Object.setPrototypeOf(r,c)}var I=(c,r,t,e)=>{let i=app.workspace.activeLeaf;i||(i=t),r||(r=i==null?void 0:i.containerEl);let s=new w(i,r,c,void 0,e);return[s.attachLeaf(),s]},W,D,O,H,w=class extends z(p.HoverPopover){constructor(t,e,i,s,a){super();this.targetEl=e;this.plugin=i;this.onShowCallback=a;this.abortController=this.addChild(new p.Component);this.detaching=!1;this.opening=!1;this.rootSplit=new p.WorkspaceSplit(window.app.workspace,"vertical");this.isPinned=!0;this.oldPopover=(W=this.parent)==null?void 0:W.hoverPopover;this.document=(H=(O=(D=this.targetEl)==null?void 0:D.ownerDocument)!=null?O:window.activeDocument)!=null?H:window.document;this.id=$(8);this.hoverEl=this.document.defaultView.createDiv({cls:"fs-block fs-leaf-view",attr:{id:"fs-"+this.id}});s===void 0&&(s=300),this.onTarget=!0,this.parent=t,this.waitTime=s,this.state=p.PopoverState.Showing;let{hoverEl:n}=this;this.abortController.load(),this.show(),this.onShow(),this.setActive=this._setActive.bind(this),T.set(this.hoverEl,this),this.hoverEl.addClass("fs-block"),this.containerEl=this.hoverEl.createDiv("fs-content"),this.buildWindowControls(),this.setInitialDimensions()}static activeWindows(){let t=[window],{floatingSplit:e}=app.workspace;if(e)for(let i of e.children)i.win&&t.push(i.win);return t}static containerForDocument(t){if(t!==document&&app.workspace.floatingSplit){for(let e of app.workspace.floatingSplit.children)if(e.doc===t)return e}return app.workspace.rootSplit}static activePopovers(){return this.activeWindows().flatMap(this.popoversForWindow)}static popoversForWindow(t){var e,i;return Array.prototype.slice.call((i=(e=t==null?void 0:t.document)==null?void 0:e.body.querySelectorAll(".fs-leaf-view"))!=null?i:[]).map(s=>T.get(s)).filter(s=>s)}static forLeaf(t){let e=t&&document.body.matchParent.call(t.containerEl,".fs-leaf-view");return e?T.get(e):void 0}static iteratePopoverLeaves(t,e){for(let i of this.activePopovers())if(i.rootSplit&&t.iterateLeaves(e,i.rootSplit))return!0;return!1}_setActive(t){t.preventDefault(),t.stopPropagation(),this.plugin.app.workspace.setActiveLeaf(this.leaves()[0],{focus:!0})}getDefaultMode(){return"source"}updateLeaves(){this.onTarget&&this.targetEl&&!this.document.contains(this.targetEl)&&(this.onTarget=!1,this.transition());let t=0;this.plugin.app.workspace.iterateLeaves(e=>{t++},this.rootSplit),t===0&&this.hide(),this.hoverEl.setAttribute("data-leaf-count",t.toString())}leaves(){let t=[];return this.plugin.app.workspace.iterateLeaves(e=>{t.push(e)},this.rootSplit),t}setInitialDimensions(){this.hoverEl.style.height="auto",this.hoverEl.style.width="100%"}transition(){this.shouldShow()?this.state===p.PopoverState.Hiding&&(this.state=p.PopoverState.Shown,clearTimeout(this.timer)):this.state===p.PopoverState.Showing?this.hide():this.state===p.PopoverState.Shown&&(this.state=p.PopoverState.Hiding,this.timer=window.setTimeout(()=>{this.shouldShow()?this.transition():this.hide()},this.waitTime))}buildWindowControls(){this.titleEl=this.document.defaultView.createDiv("popover-titlebar"),this.titleEl.createDiv("popover-title"),this.containerEl.prepend(this.titleEl)}attachLeaf(){this.rootSplit.getRoot=()=>this.plugin.app.workspace[this.document===document?"rootSplit":"floatingSplit"],this.rootSplit.getContainer=()=>w.containerForDocument(this.document),this.titleEl.insertAdjacentElement("afterend",this.rootSplit.containerEl);let t=this.plugin.app.workspace.createLeafInParent(this.rootSplit,0);return this.updateLeaves(),t}onload(){super.onload(),this.registerEvent(this.plugin.app.workspace.on("layout-change",this.updateLeaves,this)),this.registerEvent(app.workspace.on("layout-change",()=>{this.rootSplit.children.forEach((t,e)=>{t instanceof p.WorkspaceTabs&&this.rootSplit.replaceChild(e,t.children[0])})}))}onShow(){var a,n;setTimeout(()=>this.waitTime=600,600),(a=this.oldPopover)==null||a.hide(),this.oldPopover=null,this.hoverEl.toggleClass("is-new",!0),this.document.body.addEventListener("click",()=>{this.hoverEl.toggleClass("is-new",!1)},{once:!0,capture:!0}),this.parent&&(this.parent.hoverPopover=this);let e=this.hoverEl.querySelector(".view-header");e==null||e.remove();let i=this.hoverEl.querySelector(".workspace-leaf");i&&this.hoverEl.appendChild(i);let s=this.hoverEl.querySelector(".inline-title");s&&s.remove(),(n=this.onShowCallback)==null||n.call(this),this.onShowCallback=void 0}detect(t){let{targetEl:e}=this;e&&(this.onTarget=t===e||e.contains(t))}shouldShow(){return this.shouldShowSelf()||this.shouldShowChild()}shouldShowChild(){return w.activePopovers().some(t=>t!==this&&t.targetEl&&this.hoverEl.contains(t.targetEl)?t.shouldShow():!1)}shouldShowSelf(){return!this.detaching&&!!(this.onTarget||this.state==p.PopoverState.Shown||this.document.querySelector(`body>.modal-container, body > #he${this.id} ~ .menu, body > #he${this.id} ~ .suggestion-container`))}show(){this.state=p.PopoverState.Shown,this.timer=0,this.targetEl.appendChild(this.hoverEl),this.onShow(),app.workspace.onLayoutChange(),this.load(),this.hoverEl.dataset.imgHeight&&this.hoverEl.dataset.imgWidth&&(this.hoverEl.style.height=parseFloat(this.hoverEl.dataset.imgHeight)+this.titleEl.offsetHeight+"px",this.hoverEl.style.width=parseFloat(this.hoverEl.dataset.imgWidth)+"px")}onHide(){var t;this.oldPopover=null,((t=this.parent)==null?void 0:t.hoverPopover)===this&&(this.parent.hoverPopover=null)}hide(){var e;if(this.onTarget=!1,this.detaching=!0,this.timer&&(clearTimeout(this.timer),this.timer=0),this.hoverEl.hide(),this.opening)return;if(this.leaves().length)this.targetEl.empty();else return this.parent=null,(e=this.abortController)==null||e.unload(),this.abortController=void 0,this.nativeHide()}nativeHide(){var i;let{hoverEl:t,targetEl:e}=this;if(this.state=p.PopoverState.Hidden,t.detach(),e){let s=e.matchParent(".fs-leaf-view");s&&((i=T.get(s))==null||i.transition())}this.onHide(),this.unload()}resolveLink(t,e){let i=(0,p.parseLinktext)(t);return i?this.plugin.app.metadataCache.getFirstLinkpathDest(i.path,e):null}async openLink(t,e,i,s){var g,k,v;let a=this.resolveLink(t,e),n=(0,p.parseLinktext)(t);if(!a&&s){let m=this.plugin.app.fileManager.getNewFileParent(e);a=await this.plugin.app.fileManager.createNewMarkdownFile(m,n.path)}if(!a)return;let{viewRegistry:o}=this.plugin.app,h=o.typeByExtension[a.extension];if(!h||!o.viewByType[h])return;i=Object.assign(this.buildEphemeralState(a,n),i);let l=this.getDefaultMode(),u=this.buildState(l,i),f=await this.openFile(a,u,s),y=(g=f==null?void 0:f.view)==null?void 0:g.getViewType();if(y==="image"){((k=this.parent)==null?void 0:k.hasOwnProperty("editorEl"))&&this.parent.editorEl.hasClass("is-live-preview")&&(this.waitTime=3e3);let m=f.view.contentEl.querySelector("img");this.hoverEl.dataset.imgHeight=String(m.naturalHeight),this.hoverEl.dataset.imgWidth=String(m.naturalWidth),this.hoverEl.dataset.imgRatio=String(m.naturalWidth/m.naturalHeight)}else y==="pdf"&&(this.hoverEl.style.height="800px",this.hoverEl.style.width="600px");((v=u.state)==null?void 0:v.mode)==="source"&&this.whenShown(()=>{var m,S,b,L;(0,p.requireApiVersion)("1.0")&&((b=(S=(m=f==null?void 0:f.view)==null?void 0:m.editMode)==null?void 0:S.reinit)==null||b.call(S)),(L=f==null?void 0:f.view)==null||L.setEphemeralState(u.eState)})}whenShown(t){if(this.detaching)return;let e=this.onShowCallback;this.onShowCallback=()=>{this.detaching||(t(),typeof e=="function"&&e())},this.state===p.PopoverState.Shown&&(this.onShowCallback(),this.onShowCallback=void 0)}async openFile(t,e,i){if(this.detaching)return;let s=i!=null?i:this.attachLeaf();this.opening=!0;try{await s.openFile(t,e)}catch(a){console.error(a)}finally{this.opening=!1,this.detaching&&this.hide()}return this.plugin.app.workspace.setActiveLeaf(s),s}buildState(t,e){return{active:!1,state:{mode:"source"},eState:e}}buildEphemeralState(t,e){let i=this.plugin.app.metadataCache.getFileCache(t),s=i?(0,p.resolveSubpath)(i,(e==null?void 0:e.subpath)||""):void 0,a={subpath:e==null?void 0:e.subpath};return s&&(a.line=s.start.line,a.startLoc=s.start,a.endLoc=s.end||void 0),a}};function E(c,r){let t=Object.keys(r).map(e=>Z(c,e,r[e]));return t.length===1?t[0]:function(){t.forEach(e=>e())}}function Z(c,r,t){let e=c[r],i=c.hasOwnProperty(r),s=t(e);return e&&Object.setPrototypeOf(s,e),Object.setPrototypeOf(a,s),c[r]=a,n;function a(...o){return s===e&&c[r]===a&&n(),s.apply(this,o)}function n(){c[r]===a&&(i?c[r]=e:delete c[r]),s!==e&&(s=e,Object.setPrototypeOf(a,e||Function))}}var G={searchViewState:{collapseAll:!1,explainSearch:!1,extraContext:!1,matchingCase:!1,query:"",sortOrder:"alphabetical"}},J=[{type:"modal",icon:"square-equal"},{type:"sidebar",icon:"panel-left-inactive"},{type:"split",icon:"split-square-horizontal"},{type:"tab",icon:"panel-top"},{type:"window",icon:"app-window"}],C=async(c,r,t)=>{let e=r==="sidebar"?c.workspace.getLeftLeaf(!1):c.workspace.getLeaf(r);e.setPinned(r!=="sidebar"),await e.setViewState({type:"search",active:!0,state:t}),setTimeout(()=>{e.containerEl.getElementsByTagName("input")[0].focus()},0)},M=class extends d.Plugin{constructor(){super(...arguments);this.applyStateDebounceTimer=0;this.applySettingsDebounceTimer=0}applySettingsUpdate(){clearTimeout(this.applySettingsDebounceTimer),this.applySettingsDebounceTimer=window.setTimeout(async()=>{await this.saveSettings()},1e3)}applyStateUpdate(){this.applyStateDebounceTimer=window.setTimeout(()=>{clearTimeout(this.applyStateDebounceTimer),this.state={...this.state,query:""}},3e4)}async onload(){await this.loadSettings(),this.initState(),this.registerIcons(),this.patchWorkspace(),this.patchWorkspaceLeaf(),this.patchSearchView(),this.registerObsidianURIHandler(),this.registerObsidianCommands(),this.registerEditorMenuHandler(),this.registerContextMenuHandler(),this.addRibbonIcon("search","Search Obsidian In Modal",()=>this.initModal(this.state,!0,!0))}onunload(){var t;this.state=void 0,(t=this.modal)==null||t.close()}registerIcons(){(0,d.addIcon)("panel-left-inactive",'<path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 4.999687 3 L 19.000312 3 C 20.104688 3 21 3.895312 21 4.999687 L 21 19.000312 C 21 20.104688 20.104688 21 19.000312 21 L 4.999687 21 C 3.895312 21 3 20.104688 3 19.000312 L 3 4.999687 C 3 3.895312 3.895312 3 4.999687 3 Z M 4.999687 3 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 9 13.999688 L 9 15 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 9 19.000312 L 9 21 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 9 3 L 9 4.999687 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 9 9 L 9 10.000312 " transform="matrix(4.166667,0,0,4.166667,0,0)"/>'),(0,d.addIcon)("app-window",'<path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 4.000312 4.000312 L 19.999688 4.000312 C 21.105 4.000312 22.000312 4.895625 22.000312 6 L 22.000312 18 C 22.000312 19.104375 21.105 19.999688 19.999688 19.999688 L 4.000312 19.999688 C 2.895 19.999688 1.999687 19.104375 1.999687 18 L 1.999687 6 C 1.999687 4.895625 2.895 4.000312 4.000312 4.000312 Z M 4.000312 4.000312 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 10.000312 4.000312 L 10.000312 7.999687 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 1.999687 7.999687 L 22.000312 7.999687 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 6 4.000312 L 6 7.999687 " transform="matrix(4.166667,0,0,4.166667,0,0)"/>'),(0,d.addIcon)("panel-top",'<path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 4.999687 3 L 19.000312 3 C 20.104688 3 21 3.895312 21 4.999687 L 21 19.000312 C 21 20.104688 20.104688 21 19.000312 21 L 4.999687 21 C 3.895312 21 3 20.104688 3 19.000312 L 3 4.999687 C 3 3.895312 3.895312 3 4.999687 3 Z M 4.999687 3 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 3 9 L 21 9 " transform="matrix(4.166667,0,0,4.166667,0,0)"/>'),(0,d.addIcon)("square-equal",'<path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 4.999687 3 L 19.000312 3 C 20.104688 3 21 3.895312 21 4.999687 L 21 19.000312 C 21 20.104688 20.104688 21 19.000312 21 L 4.999687 21 C 3.895312 21 3 20.104688 3 19.000312 L 3 4.999687 C 3 3.895312 3.895312 3 4.999687 3 Z M 4.999687 3 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 7.000312 10.000312 L 16.999688 10.000312 " transform="matrix(4.166667,0,0,4.166667,0,0)"/><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:currentColor;stroke-opacity:1;stroke-miterlimit:4;" d="M 7.000312 13.999688 L 16.999688 13.999688 " transform="matrix(4.166667,0,0,4.166667,0,0)"/>')}initState(){this.state=this.settings.searchViewState}initModal(t,e=!1,i=!1){this.modal=new F(s=>{this.state=s,e&&this.applyStateUpdate(),this.settings.searchViewState=s,this.applySettingsUpdate()},this,{...t,query:i?"":t.query}),this.modal.open()}patchWorkspace(){let t=!1,e=E(d.Workspace.prototype,{getLeaf:i=>function(...s){let a=this.activeLeaf;if(a){let n=a.parent.containerEl.parentElement;if(n!=null&&n.hasClass("fs-content")){if(a.view.getViewType()==="markdown")return a;let o=app.workspace.getUnpinnedLeaf();o&&this.setActiveLeaf(o)}return i.call(this,...s)}return i.call(this,...s)},changeLayout(i){return async function(s){t=!0;try{await i.call(this,s)}finally{t=!1}}},iterateLeaves(i){return function(s,a){if(i.call(this,s,a))return!0;let n=typeof s=="function"?s:a,o=typeof s=="function"?a:s;if(!o||t)return!1;if(o===app.workspace.rootSplit||d.WorkspaceContainer&&o instanceof d.WorkspaceContainer){for(let h of w.popoversForWindow(o.win))if(i.call(this,n,h.rootSplit))return!0}return!1}},onDragLeaf(i){return function(s,a){return i.call(this,s,a)}},pushUndoHistory(i){return function(s,a,...n){if(s.getViewState().type!=="search")return i.call(this,s,a,...n)}}});this.register(e)}patchWorkspaceLeaf(){this.register(E(d.WorkspaceLeaf.prototype,{getRoot(t){return function(){let e=t.call(this);return(e==null?void 0:e.getRoot)===this.getRoot?e:e==null?void 0:e.getRoot()}},setPinned(t){return function(e){t.call(this,e),V(this)&&!e&&this.setPinned(!0)}},openFile(t){return function(e,i){if(V(this)){setTimeout(E(d.Workspace.prototype,{recordMostRecentOpenedFile(n){return function(o){if(o!==e)return n.call(this,o)}}}),1);let a=this.app.plugins.plugins["recent-files-obsidian"];a&&setTimeout(E(a,{shouldAddFile(n){return function(o){return o!==e&&n.call(this,o)}}}),1)}let s=t.call(this,e,i);return setTimeout(()=>{let a=this.parent.containerEl.parentElement;if(!(a!=null&&a.classList.contains("fs-content"))||e.extension!="canvas")return;let n=this.view.canvas;setTimeout(()=>{var o,h;if(n&&((o=i==null?void 0:i.eState)==null?void 0:o.match)){let l=(h=n.data.nodes)==null?void 0:h.find(u=>u.text===i.eState.match.content);l=n.nodes.get(l.id),n.selectOnly(l),n.zoomToSelection()}},20)},1),s}}}))}patchSearchView(){let t=a=>{this.state=a,this.settings.searchViewState=a,this.applySettingsUpdate()},e=a=>{var h;let n=document.querySelector(".float-search-modal")!==null,o=a.getRoot();return(o==null?void 0:o.side)&&((o==null?void 0:o.side)==="left"||(o==null?void 0:o.side)==="right")?"sidebar":((h=a.getContainer())==null?void 0:h.type)==="window"?"window":n?"modal":"split"},i=(a,n,o)=>{a.dom.toggleClass("float-search-view-menu",!0);let h=J.filter(l=>n==="split"?l.type!=="tab":l.type!==n);for(let l of h)a.addItem(u=>{u.setTitle(`${l.type} view`).setIcon(`${l.icon}`).onClick(async()=>{l.type==="modal"?(o==null||o.detach(),setTimeout(()=>{this.initModal(this.state,!0,!1)},10)):l.type==="sidebar"?await C(this.app,l.type,this.state):n==="window"?(o==null||o.detach(),setTimeout(async()=>{await C(this.app,l.type,this.state)},10)):await C(this.app,l.type,this.state),n==="modal"?this.modal.close():o==null||o.detach()})});return a},s=()=>{var o,h;let a=(o=this.app.workspace.getLeavesOfType("search")[0])==null?void 0:o.view;if(!a)return!1;let n=a.constructor;return this.register(E(n.prototype,{onOpen(l){return function(){l.call(this);let u=createDiv({cls:"float-search-view-switch"}),f=this.filterSectionToggleEl,y=new d.ExtraButtonComponent(u);y.setIcon("layout-template").setTooltip("Switch to File View"),y.onClick(()=>{let g=e(this.leaf),k=i(new d.Menu,g,this.leaf),v=u.getBoundingClientRect();k.showAtPosition({x:v.x,y:v.y+30})}),f.parentElement.insertBefore(u,f)}},startSearch(l){return function(){l.call(this);let u=this.getState();t({...u,query:this.searchComponent.getValue()})}}})),(h=a.leaf)==null||h.rebuildView(),console.log("Metadata-Style: all property view get patched"),!0};this.app.workspace.onLayoutReady(()=>{if(!s()){let a=this.app.workspace.on("layout-change",()=>{s()&&this.app.workspace.offref(a)});this.registerEvent(a)}})}registerObsidianURIHandler(){this.registerObsidianProtocolHandler("fs",t=>this.initModal({...this.state,query:t.query,current:!1},!0,!0))}createCommand(t){this.addCommand({id:t.id,name:t.name,checkCallback:e=>{let i=this.app.workspace.activeLeaf;if(!i)return;let s=i.view.getViewType();if(s==="markdown"||s==="canvas"){if(!e){let a=i.view.file,n=t.queryBuilder(a);this.initModal({...this.state,query:n,current:!0},!0,!1)}return!0}}})}registerObsidianCommands(){this.addCommand({id:"search-obsidian-globally",name:"Search Obsidian Globally",callback:()=>this.initModal({...this.state,query:"",current:!1},!1,!0)}),this.addCommand({id:"search-obsidian-globally-state",name:"Search Obsidian Globally (With Last State)",callback:()=>this.initModal({...this.state,query:"",current:!1},!0,!1)}),this.createCommand({id:"search-in-backlink",name:"Search In Backlink Of Current File",queryBuilder:t=>" /\\[\\["+(t.extension==="canvas"?t.name:t.basename)+"(\\|[^\\]]*)?\\]\\]/"}),this.createCommand({id:"search-in-current-file",name:"Search In Current File",queryBuilder:t=>` path:"${t.path}"`});for(let t of["split","tab","window"])this.addCommand({id:`open-search-view-${t}`,name:`Open Search View (${t})`,callback:async()=>C(this.app,t)})}registerEditorMenuHandler(){this.registerEvent(this.app.workspace.on("editor-menu",(t,e)=>{if(!e||e.getSelection().length===0)return;let i=e.getSelection().trim(),s=i;i.length>8?s=i.substring(0,3)+"..."+i.substring(i.length-3,i.length):s=i,t.addItem(a=>{a.setTitle('Search "'+s+'" in Float Search').setIcon("search").onClick(()=>this.initModal({...this.state,query:i,current:!1},!0,!1))})}))}registerContextMenuHandler(){this.registerEvent(this.app.workspace.on("file-menu",(t,e,i,s)=>{let a=s?w.forLeaf(s):void 0;e instanceof d.TFile&&!a&&!s&&t.addItem(n=>{var o,h;(h=(o=n.setIcon("popup-open").setTitle("Open in Float Preview").onClick(async()=>{if(this.modal){await this.modal.initFileView(e,void 0);return}this.initModal({...this.state,current:!1},!0,!0),setTimeout(async()=>{await this.modal.initFileView(e,void 0)},20)})).setSection)==null||h.call(o,"open")})}))}async loadSettings(){this.settings=Object.assign({},G,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},F=class extends d.Modal{constructor(t,e,i,s="search"){super(e.app);this.plugin=e,this.cb=t,this.state=i,this.viewType=s}async onOpen(){let{contentEl:t,containerEl:e,modalEl:i}=this;this.searchCtnEl=t.createDiv({cls:"float-search-modal-search-ctn"}),this.instructionsEl=i.createDiv({cls:"float-search-modal-instructions"}),this.initInstructions(this.instructionsEl),this.initCss(t,i,e),await this.initSearchView(this.searchCtnEl),this.initInput(),this.initContent()}onClose(){var e,i;let{contentEl:t}=this;this.cb(this.searchLeaf.view.getState()),this.searchLeaf.detach(),(e=this.fileLeaf)==null||e.detach(),this.searchEmbeddedView.unload(),(i=this.fileEmbeddedView)==null||i.unload(),t.empty()}initInstructions(t){let e=t.createDiv({cls:"float-search-modal-instructions-navigate"}),i=t.createDiv({cls:"float-search-modal-instructions-collapse"}),s=t.createDiv({cls:"float-search-modal-instructions-enter"}),a=t.createDiv({cls:"float-search-modal-instructions-alt-enter"}),n=t.createDiv({cls:"float-search-modal-instructions-tab"}),o=t.createDiv({cls:"float-search-modal-instructions-switch"}),h=e.createSpan({cls:"float-search-modal-instructions-key"}),l=e.createSpan({cls:"float-search-modal-instructions-text"});h.setText("\u2191\u2193"),l.setText("Navigate");let u=i.createSpan({cls:"float-search-modal-instructions-key"}),f=i.createSpan({cls:"float-search-modal-instructions-text"});u.setText("Shift+\u2191\u2193"),f.setText("Collapse/Expand");let y=s.createSpan({cls:"float-search-modal-instructions-key"}),g=s.createSpan({cls:"float-search-modal-instructions-text"});y.setText("\u21B5"),g.setText("Open in background");let k=a.createSpan({cls:"float-search-modal-instructions-key"}),v=a.createSpan({cls:"float-search-modal-instructions-text"});k.setText("Alt+\u21B5"),v.setText("Open File and Close");let m=n.createSpan({cls:"float-search-modal-instructions-key"}),S=n.createSpan({cls:"float-search-modal-instructions-text"});m.setText("Tab/Shift+Tab"),S.setText("Preview/Close Preview");let b=o.createSpan({cls:"float-search-modal-instructions-key"}),L=o.createSpan({cls:"float-search-modal-instructions-text"});b.setText("Ctrl+G"),L.setText("Switch Between Search and File View");let P=t.createDiv({cls:"float-search-modal-instructions-click"}),A=P.createSpan({cls:"float-search-modal-instructions-key"}),q=P.createSpan({cls:"float-search-modal-instructions-text"});A.setText("Alt+Click"),q.setText("Close Modal While In File View")}initCss(t,e,i){t.classList.add("float-search-modal-content"),e.classList.add("float-search-modal"),i.classList.add("float-search-modal-container")}async initSearchView(t){let[e,i]=I(this.plugin,t);this.searchLeaf=e,this.searchEmbeddedView=i,this.searchLeaf.setPinned(!0),await this.searchLeaf.setViewState({type:"search"}),setTimeout(async()=>{var s,a,n;await this.searchLeaf.view.setState(this.state,{history:!1}),(s=this.state)!=null&&s.current?this.searchLeaf.view.searchComponent.inputEl.setSelectionRange(0,0):this.searchLeaf.view.searchComponent.inputEl.setSelectionRange(0,(n=(a=this.state)==null?void 0:a.query)==null?void 0:n.length)},0)}initInput(){let t=this.contentEl.getElementsByTagName("input")[0];t.focus(),t.onkeydown=e=>{var s,a;let i=this.searchLeaf.view;switch(e.key){case"ArrowDown":if(e.shiftKey){i.onKeyShowMoreAfter(e),i.dom.focusedItem&&i.dom.focusedItem.collapsible&&i.dom.focusedItem.setCollapse(!1);break}else{i.onKeyArrowDownInFocus(e);break}case"ArrowUp":if(e.shiftKey){i.onKeyShowMoreBefore(e),i.dom.focusedItem&&i.dom.focusedItem.collapseEl&&i.dom.focusedItem.setCollapse(!0);break}else{i.onKeyArrowUpInFocus(e);break}case"ArrowLeft":i.onKeyArrowLeftInFocus(e);break;case"ArrowRight":i.onKeyArrowRightInFocus(e);break;case"Enter":i.onKeyEnterInFocus(e),e.altKey&&i.dom.focusedItem&&this.close();break;case"Tab":if(e.preventDefault(),e.shiftKey&&this.fileLeaf){(s=this.fileLeaf)==null||s.detach(),this.fileLeaf=void 0,(a=this.fileEmbeddedView)==null||a.unload(),this.modalEl.toggleClass("float-search-width",!1),this.fileEl.detach();break}if(i.dom.focusedItem){let n=i.dom.focusedItem,o=n.parent.file instanceof d.TFile?n.parent.file:n.file;n.parent.file instanceof d.TFile?this.initFileView(o,{match:{content:n.content,matches:n.matches}}):this.initFileView(o,void 0)}break;case"e":if(e.ctrlKey&&(e.preventDefault(),this.fileLeaf)){let n=this.fileLeaf.getViewState();n.state.mode=n.state.mode==="preview"?"source":"preview",this.fileLeaf.setViewState(n,{focus:!0}),setTimeout(()=>{this.searchLeaf.view.searchComponent.inputEl.focus()},0)}break;case"g":this.fileLeaf&&e.ctrlKey&&(e.preventDefault(),this.plugin.app.workspace.setActiveLeaf(this.fileLeaf,{focus:!0}));break;case"C":if(e.ctrlKey&&e.shiftKey){e.preventDefault();let n=i.dom.focusedItem.el.innerText;navigator.clipboard.writeText(n)}break}}}initContent(){let{contentEl:t}=this;t.onclick=e=>{if(t.getElementsByClassName("search-results-children")[0].children.length<2)return;let s=e.target;if(e.altKey||!this.fileLeaf){for(;s&&!s.classList.contains("tree-item-icon");){if(s.classList.contains("tree-item")){this.close();break}s=s.parentElement}return}if(this.fileLeaf){let a=this.searchLeaf.view;if(this.searchCtnEl.contains(s)){for(;s&&!s.classList.contains("tree-item");)s=s.parentElement;if(!s)return;let o=(s==null?void 0:s.getElementsByClassName("tree-item-inner")[0]).innerText,h=this.plugin.app.metadataCache.getFirstLinkpathDest(o,"");if(h){let l=a.dom.resultDomLookup.get(h);a.dom.setFocusedItem(l),this.initFileView(h,void 0),this.searchLeaf.view.searchComponent.inputEl.focus()}}return}}}async initFileView(t,e){var n,o,h;if(this.fileLeaf){await this.fileLeaf.openFile(t,{active:!1,eState:e}),((o=(n=this.fileState)==null?void 0:n.match)==null?void 0:o.matches[0])===((h=e==null?void 0:e.match)==null?void 0:h.matches[0])&&e&&this.fileState?setTimeout(()=>{this.fileLeaf&&this.plugin.app.workspace.setActiveLeaf(this.fileLeaf,{focus:!0})},0):(this.fileState=e,setTimeout(()=>{this.searchLeaf.view.searchComponent.inputEl.focus()},0));return}let{contentEl:i}=this;if(this.fileEl=i.createDiv({cls:"float-search-modal-file-ctn"}),this.modalEl.toggleClass("float-search-width",!0),this.fileEl.onkeydown=l=>{l.ctrlKey&&l.key==="g"&&(l.preventDefault(),l.stopPropagation(),this.searchLeaf.view.searchComponent.inputEl.focus()),l.key==="Tab"&&l.ctrlKey&&(l.preventDefault(),l.stopPropagation(),this.searchLeaf.view.searchComponent.inputEl.focus())},!this.fileEl)return;let[s,a]=I(this.plugin,this.fileEl);this.fileLeaf=s,this.fileEmbeddedView=a,this.fileLeaf.setPinned(!0),await this.fileLeaf.openFile(t,{active:!1,eState:e}),this.fileState=e,this.searchLeaf.view.searchComponent.inputEl.focus()}};
